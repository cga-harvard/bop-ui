/*! Solr-Heatmap-Client created on 22-06-2016 */
angular.module("SolrHeatmapApp",["ui.bootstrap"]),angular.module("SolrHeatmapApp").controller("BackgroundLayerCtrl",["Map","$scope",function(a,b){b.layers={},b.selectedLayer={},b.$on("mapReady",function(a,c){b.layers=c.getLayers().getArray(),b.selectedLayer={name:b.getBackgroundLayers()[0].get("name")}}),b.isBackgroundLayer=function(a){var b=!1;return a.get("backgroundLayer")&&(b=!0),b},b.setBackgroundLayer=function(a){angular.forEach(b.getBackgroundLayers(),function(c){c===a?(a.setVisible(!0),b.selectedLayer={name:a.get("name")}):c.setVisible(!1)})},b.getBackgroundLayers=function(){var b=a.getMap().getLayers().getArray();return b.filter(function(a){return!!a.get("backgroundLayer")})}}]),angular.module("SolrHeatmapApp").controller("DatePickerCtrl",["HeatMapSourceGenerator","$scope",function(a,b){b.initialDateOptions={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31")},b.dateOptions={minDate:a.getSearchObj().minDate,maxDate:a.getSearchObj().maxDate,startingDay:1,showWeeks:!1},b.openStartDate=function(){b.startDate.opened=!0,b.dateOptions.minDate=b.initialDateOptions.minDate,b.dateOptions.maxDate=b.dte},b.openEndDate=function(){b.endDate.opened=!0,b.dateOptions.maxDate=b.initialDateOptions.maxDate,b.dateOptions.minDate=b.dts},b.startDate={opened:!1},b.endDate={opened:!1},b.setInitialDates=function(){b.dts=b.dateOptions.minDate,b.dte=b.dateOptions.maxDate},b.setInitialDates(),b.onChangeStartDate=function(){b.setDateRange(b.dts,b.dte),a.performSearch()},b.onChangeEndDate=function(){b.setDateRange(b.dts,b.dte),a.performSearch()},b.setDateRange=function(b,c){a.setMinDate(b),a.setMaxDate(c)}}]),angular.module("SolrHeatmapApp").controller("ExportCtrl",["Map","$scope","$filter","$timeout",function(a,b,c,d){b.startExport=function(){console.log("Here will be an awesome export")}}]),angular.module("SolrHeatmapApp").controller("mainCtrl",["Map","HeatMapSourceGenerator","$http","$scope","$rootScope",function(a,b,c,d,e){solrHeatmapApp=this,c.get("./config/appConfig.json").success(function(c,d,f,g){if(!c||!c.mapConfig)throw"Could not find the mapConfig";var h=c.mapConfig,i=c.appConfig;a.init({mapConfig:h}),solrHeatmapApp.appConfig=i,solrHeatmapApp.initMapConf=h,solrHeatmapApp.map=a.getMap(),e.$broadcast("mapReady",a.getMap()),solrHeatmapApp.map.on("moveend",function(a){b.performSearch()}),solrHeatmapApp.map.getView().on("change:resolution",function(b){var c=a.getLayersBy("name","HeatMapLayer");if(c&&c.length>0){var d=500*b.target.getResolution(),e=c[0];d>15&&(d=15),e.setRadius(d),e.setBlur(2*d)}})}).error(function(a,b,c,d){throw"Error while loading the config.json"})}]),angular.module("SolrHeatmapApp").controller("ResultCounterCtrl",["$scope",function(a){a.$on("setCounter",function(b,c){c<1&&(c="No results found"),a.counter=c})}]),angular.module("SolrHeatmapApp").controller("SearchCtrl",["Map","HeatMapSourceGenerator","$scope","$http",function(a,b,c,d){function e(a){return window.event?a.keyCode:a.which}c.searchInput="",c.onKeyPress=function(a){13===e(a)&&c.doSearch()},c.doSearch=function(){b.setSearchText(c.searchInput),b.performSearch()},c.resetSearchInput=function(){c.searchInput="",b.setSearchText(""),b.performSearch()}}]),angular.module("SolrHeatmapApp").controller("YearSlideCtrl",["Map","HeatMapSourceGenerator","$scope","$filter","$timeout",function(a,b,c,d,e){c.ys={years:{min:b.getSearchObj().yearMin,max:b.getSearchObj().yearMax,options:{floor:2005,ceil:2016,noSwitching:!0}}},c.$on("slideEnded",function(){var a=c.ys.years.min,d=c.ys.years.max;b.setMinYear(a),b.setMaxYear(d),b.performSearch()})}]),angular.module("SolrHeatmapApp").factory("HeatMapSourceGenerator",["Map","$rootScope","$filter","$http",function(a,b,c,d){function e(a){n.searchText=a}function f(a){n.minDate=a}function g(a){n.maxDate=a}function h(){return n}function i(){var b=a.getMap(),c=b.getView().getProjection().getCode(),d=b.getView().calculateExtent(b.getSize()),e=ol.proj.transformExtent(d,c,"EPSG:4326"),f={};if(d&&e){var g=e[1],h=e[3],i=l(e[0]),j=l(e[2]);f={minX:g,maxX:h,minY:i<j?i:j,maxY:j>i?j:i}}return f}function j(){var c={},e=this.getTweetsSearchQueryParameters(this.getGeospatialFilter());e&&(c={url:solrHeatmapApp.appConfig.tweetsSearchBaseUrl,method:"GET",params:e},d(c).success(function(c,d,e,f){c&&c["a.hm"]&&(a.createOrUpdateHeatMapLayer(c["a.hm"]),b.$broadcast("setCounter",c["a.matchDocs"]))}).error(function(a,b,c,d){console.log("An error occured while reading heatmap data")}))}function k(a){var b,c=this.getSearchObj();b=0===c.searchText.length?"*":c.searchText;var d={"q.text":b,"q.time":"["+this.getFormattedDateString(c.minDate)+" TO "+this.getFormattedDateString(c.maxDate)+"]","q.geo":"["+a.minX+","+a.minY+" TO "+a.maxX+","+a.maxY+"]","a.hm.limit":1e3};return d}function l(a){var b=Math.floor((a+180)/360);return a-360*b}function m(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)}var n={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31"),searchText:""},o={getGeospatialFilter:i,getTweetsSearchQueryParameters:k,performSearch:j,setSearchText:e,setMinDate:f,setMaxDate:g,getFormattedDateString:m,getSearchObj:h};return o}]),angular.module("SolrHeatmapApp").factory("Map",["$rootScope","$filter","$http",function(a,b,c){function d(a){var b=angular.extend(p.view,a.mapConfig.view),c=angular.extend(p.renderer,a.mapConfig.renderer),d=a.mapConfig.layers;o=new ol.Map({controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.ZoomSlider]),interactions:ol.interaction.defaults(),layers:e(d),renderer:angular.isString(c)?c:void 0,target:"map",view:new ol.View({center:angular.isArray(b.center)?b.center:void 0,maxResolution:angular.isNumber(b.maxResolution)?b.maxResolution:void 0,minResolution:angular.isNumber(b.minResolution)?b.minResolution:void 0,maxZoom:angular.isNumber(b.maxZoom)?b.maxZoom:void 0,minZoom:angular.isNumber(b.minZoom)?b.minZoom:void 0,projection:angular.isString(b.projection)?b.projection:void 0,resolution:angular.isString(b.resolution)?b.resolution:void 0,resolutions:angular.isArray(b.resolutions)?b.resolutions:void 0,rotation:angular.isNumber(b.rotation)?b.rotation:void 0,zoom:angular.isNumber(b.zoom)?b.zoom:void 0,zoomFactor:angular.isNumber(b.zoomFactor)?b.zoomFactor:void 0})})}function e(a){var b,c=[];return angular.isArray(a)&&angular.forEach(a,function(a){"TileWMS"===a.type&&(b=new ol.layer.Tile({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.TileWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,ratio:a.ratio,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),"ImageWMS"===a.type&&(b=new ol.layer.Image({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.ImageWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),c.push(b)}),c}function f(a,c){var d=solrHeatmapApp.map.getLayers().getArray();return b("filter")(d,function(b){return b.get(a)===c})}function g(a){var c=solrHeatmapApp.map.getInteractions().getArray();return b("filter")(c,function(b){return b instanceof a})}function h(a,c){return b("filter")(a,function(a){return a.type_===c})}function i(){return o}function j(b){var c=b.coordinate,d=o.forEachFeatureAtPixel(b.pixel,function(a,b){return a}),e="",f=document.getElementById("popup"),g=document.getElementById("popup-content"),h=document.getElementById("popup-closer");h.onclick=function(){return i.setPosition(void 0),h.blur(),!1};var i=new ol.Overlay({element:f,autoPan:!0,autoPanAnimation:{duration:250}});if(o.getOverlays().clear(),o.addOverlay(i),d){var j=d.get("origVal");j&&a.$broadcast("featureInfoLoaded",j)}a.$on("featureInfoLoaded",function(a,b){e+="<h5>Number of elements: </h5>"+b,g.innerHTML=e;var d=solrHeatmapApp.map.getOverlays().getArray()[0];d&&d.setPosition(c)})}function k(a){var b,c=this.createHeatMapSource(a),d=this.getLayersBy("name","HeatMapLayer");if(d&&d.length>0){var e=d[0],f=e.getSource();f&&f.clear(),e.setSource(c)}else b=new ol.layer.Heatmap({name:"HeatMapLayer",source:c,radius:10}),o.addLayer(b)}function l(a){var b,c=a.counts_ints2D,d=(a.gridLevel,a.columns),e=a.rows,f=a.minX,g=a.minY,h=a.maxX,i=a.maxY,j=a.projection,k=h-f,l=i-g,m=k/d,n=l/e,o=[],p=this.getMap();if(!c)return null;b=this.heatmapMinMax(c,e,d);for(var q=0;q<e;q++)for(var r=0;r<d;r++){var s,t,u,v,w=c[c.length-q-1][r];if(w&&null!==w){t=g+q*n+.5*n,s=f+r*m+.5*m,v=ol.proj.transform([s,t],j,p.getView().getProjection().getCode()),u=new ol.Feature({geometry:new ol.geom.Point(v)});var x=this.rescaleHeatmapValue(w,b);u.set("weight",x),u.set("origVal",w),o.push(u)}}return olVecSrc=new ol.source.Vector({features:o,useSpatialIndex:!0}),olVecSrc}function m(a,b,c){for(var d=-1,e=Number.MAX_VALUE,f=0;f<b;f++){var g=a[f];null===g&&(a[f]=g=[]);for(var h=0;h<c;h++)null===g[h]&&(g[h]=-1),g[h]>d&&(d=g[h]),g[h]<e&&g[h]>-1&&(e=g[h])}return[e,d]}function n(a,b){return null===a?0:a==-1?-1:0===a?0:b[1]-b[0]===0?0:(a-b[0])/(b[1]-b[0])}var o={},p={renderer:"canvas",view:{center:[0,0],projection:"EPSG:3857",zoom:2}},q={init:d,getMap:i,getLayersBy:f,getInteractionsByClass:g,getInteractionsByType:h,displayFeatureInfo:j,createOrUpdateHeatMapLayer:k,createHeatMapSource:l,heatmapMinMax:m,rescaleHeatmapValue:n};return q}]);